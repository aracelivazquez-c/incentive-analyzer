import streamlit as st
import pandas as pd
import openai
import os

# -------------------------
# CONFIGURACI√ìN OPENAI API
# -------------------------
openai.api_key = os.getenv("OPENAI_API_KEY")  # Obtener la API Key desde las variables de entorno

# -------------------------
# T√çTULO Y DESCRIPCI√ìN
# -------------------------
st.title("üìä Incentive Analyzer AI")
st.write("""
Carga tus datos mensuales de transacciones y esquema de bonos, y deja que la IA analice tendencias, sugiera mejoras y te alerte sobre posibles problemas.
""")

# -------------------------
# INPUTS DEL USUARIO
# -------------------------
# 1. Subir archivo CSV
uploaded_file = st.file_uploader("Carga tu archivo de transacciones (CSV)", type=['csv'])

# 2. Texto libre: descripci√≥n del esquema de bonos
bono_text = st.text_area("Describe aqu√≠ el sistema de bonos y objetivos clave de este mes", height=200)

# 3. Opcional: M√©tricas clave
metrics = st.text_input("¬øCu√°les son las m√©tricas clave a mejorar este mes? (separadas por comas)")

# -------------------------
# PROCESAMIENTO DE DATOS
# -------------------------
if uploaded_file and bono_text:
    df = pd.read_csv(uploaded_file)
    st.subheader("Vista previa de datos")
    st.dataframe(df.head())

    # Procesamiento b√°sico
    st.write("Resumen estad√≠stico r√°pido:")
    st.write(df.describe())

    # -------------------------
    # ENV√çO A OPENAI (LLM)
    # -------------------------
    st.subheader("üîé An√°lisis Inteligente")

    # Preparar prompt
    prompt = f"""
Act√∫a como un analista de incentivos. Aqu√≠ est√° el esquema de bonos:

{bono_text}

Estas son las m√©tricas clave que la organizaci√≥n busca mejorar:
{metrics}

Aqu√≠ est√°n los datos de transacciones del mes (columnas: {', '.join(df.columns)}):
{df.head(20).to_csv(index=False)} 

Por favor:
1. Detecta tendencias importantes (positivas o negativas).
2. Se√±ala cualquier patr√≥n preocupante.
3. Sugiere ajustes al sistema de bonos para mejorar las m√©tricas clave.
4. Lanza cualquier advertencia si es necesario.
"""

    with st.spinner("Analizando con IA..."):
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )
        analysis = response['choices'][0]['message']['content']
        st.success("¬°An√°lisis completado!")
        st.markdown(analysis)

    # -------------------------
    # DESCARGAR REPORTE (Opcional)
    # -------------------------
    st.download_button("Descargar reporte", analysis, file_name="incentive_report.txt")

else:
    st.info("Carga tus datos y descripci√≥n para comenzar.")
